# 新建设备模板

设备模板的创建主要以下方式：

- 通过 **添加按钮** 在线创建新模板
- 基于现有设备模板导出模板，而后基于此模板离线做修改，再导入EnOS

后者适用于两种设备模板近似的场景，通过复制的方式获取副本而后稍作修改得到新模板，可减少实施的工作量。

## 任务描述

本文介绍了通过EnOS控制台进行模板管理的步骤。

## 开始前准备

- 如需新建、更新、发布、删除模板，你需要获得该OU管理员权限。

## 在线创建模板

### 在线创建模板基本信息

1. 选择 **Edge网关 > 模板配置**，点击 **添加** 按钮，按照界面提示填入相关信息，其中：

- 设备模型：该字段的选择将决定设备具有的模型点，即模型定义的属性
      
   .. image:: ../../media/edge_template_create.png

2. 点击 **确定**，完成新模板基本信息的创建。

### 编辑并上传点表文件point.xlsx

1. 在设备模板列表中找到刚刚创建的模板，在操作栏选择**编辑**，进入模板编辑页面;

2. 在基本信息处，点表文件一栏，点击 |downloadTemplate| 图标，根据模板将会使用的规约及版本选择对应的点表模板，点击下载 *point.xlsx*；

 .. |downloadTemplate| image:: ../../media/button_download_template.png

3. 打开点表文件，点表文件除首行字段名称之外的信息皆为示例，可以删除。在点表文件中录入设备测点相关信息，说明如下：

   .. image:: ../../media/point_csv_file.png

   .. csv-table::

      "字段", "字段说明"
      "测点名", "即从设备上采集到的数据点，建议使用易于辨识的字段，此字段不会被EnOS作为测点名显示。"
      "点号", "表示设备点位置的信息，依据规约而不同，EnOS会根据点号确定将测点映射到EnOS模型上的属性"
      "值类型", "测点的数据类型，详细信息见下文"
      "点类型", "EnOS支持的点类型"
      "系数", "如果为了转换数据类型或者单位，在通信规约中要执行类似a(x+b)的运算，a即为此处的系数，应根据需要自定义该系数的值"
      "基值", "如果为了转换数据类型或者单位，在通信规约中要执行类似a(x+b)的运算，b即为此处的基值，应根据需要自定义该基值的值"
      "别名", "此别名会作为测点的一个属性被上传，默认值为点号。如果需要将采集到的数据点自动映射到相关测点，此处应填写对应测点的标识符"


  不同规约支持的测点数据类型各不相同，通常需要配置以下类型的测点：

  - byte
  - short
  - ushort
  - int
  - uint
  - long
  - float
  - double


4. 填写完成并保存文件，点击 |upload| 。

 .. |upload| image:: ../../media/button_upload.png

你也可以点击 |edit|，在线编辑点表文件。

 .. |edit| image:: ../../media/button_edit.png

### 配置点映射

上传了点表模型point.csv文件后，需要将设备采集点和控制点映射至模型测点。

1. 在选定的模板的操作栏，点击 |edit| ，进入模板编辑页；

 .. |edit| image:: ../../media/button_edit.png

2. 在点映射栏的列表中，系统根据设备采用的模型，列出了全部模型测点；

   .. image:: ../../media/edge_template_model_points.png

3. 在映射栏，对需要配置点映射的模板属性，点击**映射关系点**，进入映射配置页面：

   .. image:: ../../media/edge_template_mapping_config.png

4. 如需将设备采集点映射至模型测点，则在采集页面进行点映射配置；用户可以选择一对一映射或公式映射，参见[边缘计算](../../learn/edge_computing)；

5. 如需将设备控制点映射至模型测点，则在控制页面进行点映射配置；用户只能选择一对一映射的方式；同一个模型测点，可以既映射设备采集点，又映射设备控制点。

   在控制页下，AO型的设备点，其值不可设置，由应用直接下发测点值；DO型的设备点，其取值可在测点右侧输入框中填写，若不填写，则以应用下发的测点值代替

   .. image:: ../../media/edge_template_model_control_points.png

   你也可以通过导出/导入方式批量配置点映射，文件格式为.xlsx。通过该种方式智能配置一对一映射，不能配置复杂公式类映射。

   如果点表文件中，**别名** 一栏都填写了对应测点的标识符，可以点击 **自动映射即可将采集到的数据点映射到模型测点，该方法只适用于一对一映射。

6. 设定模型测点的上送类型。EnOS支持以下上送类型：

   - 实时上送：Edge采集到一个点就立刻发送到云端
   - 定时上送：Edge以用户设定的上送周期将采集点值上送至EnOS
   - 变化上送：Edge在采集点值发生变化时，将最新的采集点值上送到EnOS
   - 不上送：该测点相关数据不上送至EnOS

### 设定设备时间戳

在 **使用设备时标** 一栏，针对已完成映射的测点，你可以选择使用设备自带的时间戳或系统时间戳。

### 编写边缘计算脚本

在脚本栏选择 **创建**，在弹出的创建脚本窗口中即可在线编辑脚本。

你也可以选择 **导出**，下载脚本模板之后离线编辑脚本，再使用**导入**上传脚本。

关于脚本编写规范，参见[边缘计算](../../learn/edge_computing)

点击 **保存**，完成模板创建。

## 通过导出/导入方式配置模板

1. 选择 **Edge网关 > 模板配置**，在模板列表中勾选模板，选择 **导出**，下载现有设备模板信息作为基础模板；

2. 在下载的json文件中，编辑响应的字段，修改模板，点击 **导入**，上传修改后的json文件，完成模板的创建。

## 修改设备模板

设备模板创建成功后，可以点击 **编辑** 进行修改。如果该模板正在被Edge设备使用，修改完模板，点击 **保存** 之后，会弹出对话框。用户需要选择修改后模板影响的Edge设备。

- 如果选择了全部Edge设备，EnOS将直接更新原模板；
- 如果选择了部分Edge设备，则EnOS会为被选择的部分Edge创建一个新的模板，其名称为“原模板名称_copy”，如下图所示：

.. image:: ../../media/edge_template_edit_confirm.png

## 创建转发模板

你可以在 **转发模板** 标签页中，创建转发模板，从模型的测点中挑选出需要转发的测点，让Edge转发至第三方系统。

创建转发模板的步骤与创建接入模板的步骤基本相同。以下步骤需要注意：

### 添加转发点

点击“添加转发点”，可在弹出的对话框中添加转发点，如下图所示：

.. image:: ../../media/creating_forwarding_template.png


- 左侧是模型点列表，右侧是转发点列表。用户需先选择转发点类型（AI,DI,PI,AO,DO），而后可通过点击左侧模型点后的 将模型点添加为对应转发类型的转发点。
- 除了可添加模型点为转发点外，还可添加占位点为转发点。占位点只占据点位，不会有真实数据通过占位点转发出去。在某些情况下，后期需要增加转发模型点，如果之前配置了占位点，则此时可在不更改转发点数量和顺序的情况下，将占位点替换为新增的模型点。
- 可通过点击转发点操作栏中的 将当前转发点改为占位点，可通过点击转发点操作栏中的 删除当前占位点。
- 需要注意的是，增删转发点、修改转发点顺序、修改转发点功能码，有可能影响最终的转发点点号，可能需要修改接收端的相关配置来应对。因此用户在修改转发点时需要格外注意。

### 配置转发点参数

转发点有关参数的说明如下：

.. csv-table:: 转发点参数说明
   :widths: auto
   :header: "参数", "说明"

   "点号", "点号是根据转发点类型与转发点排序自动生成的，用户可通过导出转发点表来修改转发点的排序，在导入后系统会重新计算并生成新的转发点号"
   "模型点名", "即当前转发点所对应的模型点名称，不可修改"
   "模型点标识符", "即当前转发点所对应的模型点标识符，不可修改"
   "转发点类型", "指转发点通过哪种类型转发出去，支持的转发点类型包括：AI, DI, PI, AO, DO"
   "转发数据类型", "指转发点以哪种数据类型转发出去，不同转发点类型下可选的转发数据类型不同，具体见下文。"
   "系数", "转发出去的值未必与原始值相同，支持为转发值配置系数。逻辑如下：若y=ax+b，则x为原始的待转发值，a为系数，b为基值，y为最终转发出去的值。默认值为1"
   "基值", "转发出去的值未必与原始值相同，支持为转发值配置基值（偏移量）。逻辑如下：若y=ax+b，则x为原始的待转发值，a为系数，b为基值，y为最终转发出去的值。默认值为0"


<!--end-->
